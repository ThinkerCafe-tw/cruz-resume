name: ðŸŒ Auto-Translate Resume

on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
    inputs:
      dry_run:
        description: 'Dry run (ä¸å„²å­˜çµæžœ)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  translate:
    name: Translate to Multiple Languages
    runs-on: ubuntu-latest

    permissions:
      contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä»¥ commit æ›´æ”¹

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ­·å²è¨˜éŒ„

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # å¿«å– pip ä¾è³´

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd scripts
          pip install -r requirements.txt

      - name: ðŸ” Check Environment
        run: |
          echo "Python version: $(python --version)"
          echo "Working directory: $(pwd)"
          echo "Files in scripts/:"
          ls -la scripts/
          echo "Prompts available:"
          ls -la scripts/prompts/

      - name: ðŸ¤– Run Translation Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "ðŸ” Running in DRY RUN mode (no changes will be saved)"
            # TODO: Add --dry-run flag to translate.py
            python scripts/translate.py
            echo "âš ï¸  Dry run completed. No changes saved."
          else
            echo "ðŸš€ Running translation..."
            python scripts/translate.py
          fi

      - name: ðŸ“Š Check for Changes
        id: check_changes
        run: |
          if git diff --quiet data.json; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes detected in data.json"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in data.json"
            git diff --stat data.json
          fi

      - name: ðŸ’¾ Commit and Push Changes
        if: steps.check_changes.outputs.changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "Translation Bot"
          git config user.email "bot@thinker.cafe"
          git add data.json

          # ç”Ÿæˆè©³ç´°çš„ commit message
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ðŸŒ Auto-translate: Update all languages

          - Translated from zh-TW to en, ja, ko, ar
          - Using Gemini 2.5 Flash API
          - Timestamp: $TIMESTAMP

          ðŸ¤– Generated with [Cruz Resume Translation Workflow]"

          git push

      - name: ðŸ“ Summary
        if: always()
        run: |
          echo "## ðŸŒ Translation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "**Mode**: ðŸ” Dry Run (no changes saved)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode**: ðŸš€ Production" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "**Result**: âœ… Translations updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git diff --stat data.json >> $GITHUB_STEP_SUMMARY || echo "No diff available" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Result**: â„¹ï¸  No changes needed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Languages**: en, ja, ko, ar" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Handle Errors
        if: failure()
        run: |
          echo "## âŒ Translation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Common issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Missing GEMINI_API_KEY secret" >> $GITHUB_STEP_SUMMARY
          echo "- API quota exceeded" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid JSON structure in data.json" >> $GITHUB_STEP_SUMMARY
